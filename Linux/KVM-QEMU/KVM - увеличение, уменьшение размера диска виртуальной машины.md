2021-02-20  
[Оригинальная статья](https://winitpro.ru/index.php/2019/10/01/kvm-uvelichit-umenshit-razmer-virt-diska/#h2_1)
```table-of-contents
title: Содержание:
style: nestedList # TOC style (nestedList|inlineFirstLevel)
minLevel: 0 # Include headings from the specified level
maxLevel: 0 # Include headings up to the specified level
includeLinks: true # Make headings clickable
debugInConsole: false # Print debug info in Obsidian console
```
## Увеличение диска виртуальной машины KVM

### Расширение виртуального диска со стороны KVM

Для того, чтобы проводить работы с диском, виртуальная машина должна быть отключена, иначе мы не сможем что-либо сделать. Рассмотрим пример с увеличением диска размер которого изначально был 20Гб.

Чтобы посмотреть параметры диска виртуальной машины KVM, воспользуйтесь командой:

`qemu-img info /путь_до_диска`

Вывод команды будет примерно такой:

![qemu-img информация о диске виртуальной машины|350](/Media/Pictures/KVM_Resize_Volume/image_1.png)

Мы видим, что у нас есть два поля которые указывают на размер, это virtual_size и disk_size:

- **virtual_size** – размер виртуального диска, указанный при создании или расширении диска (в этом примере максимальный размер диска – 20 Гб);
- **disk_size** — размер файла диска в текущий момент, т.е. сколько сейчас занимает образ диска места на физическом сервере (относится только к формату qcow). В нашем пример виртуальный диск занимает всего 1,6 Гб на хранилище.

И сразу о форматах. Я рекомендую при [создании виртуальных машин на KVM](https://winitpro.ru/index.php/2020/02/04/ustanovka-zapusk-kvm-v-linux-centos/) использовать формат диска qcow2, а не raw. Чуть позже я объясню почему.

Следующим шагом расширим диск виртуальной машины, на 5Gb (для корректного расширения диска у виртуальной машины не должно быть снапшотов!).
```shell
qemu-img resize /путь до диска +5G
```

`Image resized.`

Если сразу проверить вывод информации об образе диска, мы увидим, что он расширился:
```shell
qemu-img info /путь_до_диска
```

```
image: /путь_до_диска
file format: qcow2
virtual size: 25G (26843545600 bytes)
disk size: 1.6G
cluster_size: 65536
Format specific information:
compat: 0.10
refcount bits: 16
```

Часть работы мы сделали, но требуется и проведение работ со стороны виртуальной машины в гостевой ОС. Далее мы покажем, как увеличить размер диска в гостевых CentOS 7 и Windows Server 2012.

Если вы планируете добавить дополнительный виртуальный диск для ВМ на KVM гипервизоре, используются qemu-img и [virsh](https://winitpro.ru/index.php/2020/02/10/virsh-upravlenie-virtualnymi-mashinami-kvm/).
### Расширение раздела в виртуальной машине с Linux CentOS

После расширения диска со стороны сервера, нужно запустить виртуальную машину и подключиться к ней по ssh. Все работы будут проводиться с помощью утилиты управления разделами жестких дисков **fdisk**.

После подключения к серверу, проверяем наличие нашего дополнительно подключенного места:
```shell
df -h
fdisk -l
```

![добавление места в гостевой linux|500](/Media/Pictures/KVM_Resize_Volume/image_2.png)

На скриншоте видно, раздел /dev/vda2 имеет размер 20Gb, а доступное место на диске у нас больше.

Подправим этот момент и расширим раздел /dev/vda2 до максимального объема:
```shell
fdisk /dev/vda
```

```
Welcome to fdisk (util-linux 2.23.2).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.
Command (m for help): **d**
Partition number (1,2, default 2):
Partition 2 is deleted
Command (m for help): **n**
Partition type:
p primary (1 primary, 0 extended, 3 free)
e extended
Select (default p): **p**
Partition number (2-4, default 2):
First sector (1050624-52428799, default 1050624):
Using default value 1050624
Last sector, +sectors or +size{K,M,G} (1050624-52428799, default 52428799):
Using default value 52428799
 Partition 2 of type Linux and of size 24.5 GiB is set
Command (m for help): **w**
The partition table has been altered!
Calling ioctl() to re-read partition table.
WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
```

После чего нам нужно сделать рестарт виртуальной машины и выполнить команду для применения расширения диска:

```shell
xfs_growfs /dev/vda2
```

```
meta-data=/dev/vda2 isize=512 agcount=4, agsize=1277888 blks
= sectsz=512 attr=2, projid32bit=1
= crc=1 finobt=0 spinodes=0
data = bsize=4096 blocks=5111552, imaxpct=25
= sunit=0 swidth=0 blks
naming =version 2 bsize=4096 ascii-ci=0 ftype=1
log =internal bsize=4096 blocks=2560, version=2
= sectsz=512 sunit=0 blks, lazy-count=1
realtime =none extsz=4096 blocks=0, rtextents=0
data blocks changed from 5111552 to 6422272
```

```shell
df -h
```

```
Filesystem Size Used Avail Use% Mounted on
devtmpfs 485M 0 485M 0% /dev
tmpfs 496M 0 496M 0% /dev/shm
tmpfs 496M 6.6M 489M 2% /run
tmpfs 496M 0 496M 0% /sys/fs/cgroup
/dev/vda2 25G 1.3G 24G 6% /
/dev/vda1 488M 100M 353M 23% /boot
tmpfs 100M 0 100M 0% /run/user/0
```

В итоге мы получили расширенный раздел /dev/vda2. Теперь по порядку, что именно мы сделали:

- **fdisk /dev/vda** — запустили утилиту fdisk подключившись к разделу /dev/vda
- **/d** — удаляем раздел, по умолчанию это раздел 2 который нам и нужен, поэтому в следующем пункте жмем просто Enter
- **/n** – создаем новый раздел, в следующем пункте так же просто жмем Enter или вводим **p**, далее Enter так как создаваемый раздел по умолчанию будет 2.
- При указании первого и последнего сектора так же жмем просто Enter, если мы хотим расширить раздел до максимума, если вы хотите указать конкретный размер, в последнем секторе указывайте размер диска как указано в меню +size{K,M,G} Размер не может быть меньше, чем был ранее!
- **/w** — применяем наши настройки.

После перезагрузки проверим диск командой:

```shell
xfs_growfs /dev/vda2
```

В некоторых источниках для выполнения данной процедуры указывают команду:

```shell
resize2fs /dev/vda2
```

Но с файловой системой xfs это не работает!

Работы по расширению диска на виртуальной машине с ОС CentOS 7 закончены.
### Увеличение диска в гостевой Windows Server

Подключаемся к виртуальной машине через rdp или VNC и выполняем работы по расширению диска.

1. Откройте Server Manager -> Tools -> Computer Management;

2. В открывшемся окне выбираем в меню **Disk Management**, после чего у вас должны отобразиться все ваши диски и неразмеченное пространство, которые мы добавили со стороны гипервизора KVM;
![windows неразмеченное пространство|800](/Media/Pictures/KVM_Resize_Volume/image_3.png)

3. Выбираем нужный диск и нажимаем Extended Volume;
 ![extend volume|800](/Media/Pictures/KVM_Resize_Volume/image_4.png)

4. По умолчанию для увеличения размера диска будет предложено все доступное место;
 ![расширить диск в windows server|500](/Media/Pictures/KVM_Resize_Volume/image_5.png)

5. Нажимаем «далее» и завершаем расширение. После данной процедуры, ваш раздел в системе должен будет расшириться;
![диск успешно увеличен|800](/Media/Pictures/KVM_Resize_Volume/image_6.png)

Хотелось бы добавить, что перед процедурой расширения диска для виртуальной машины, я советую выполнять [резервное копирование](https://winitpro.ru/index.php/2020/03/04/backup-virtualnyx-mashin-v-kvm/) самого диска. Остановите виртуальную машину и скопируйте образ диска в директорию для бэкапа или в любую директорию, в которой есть [свободное место](https://winitpro.ru/index.php/2021/02/20/svobodnoe-mesta-na-diske-v-linux/). Если в ходе работ, что-то пойдет не так, вы всегда сможете вернуть образ виртуального диска из бэкапа.
## Уменьшение диска виртуальной машины KVM

В своей работе, ранее я довольно часто сталкивался с данным вопросом, но к сожалению, безболезненно уменьшить диск на виртуальной машине в KVM нельзя! Единственный приемлемый размер уменьшения размер диска виртуальной машины KVM на физическом хранилище – его сжатие через конвертацию.  
В интернете фигурирует много статей, якобы благодаря которым вы можете уменьшить размер диска на виртуальной машине, но это не работает.  
Я приведу несколько примеров, на которые я натыкался и которые лично мною были проверены.
### Уменьшение KVM диска с помощью утилиты qemu

На ряде ресурсов описаны действия, выполняемые с помощью утилиты qemu. В них предлагается уменьшить размер диска виртуальной машины с помощью команды:

уменьшаем диск на 5G
```shell
qemu-img resize /путь_до_диска -5G
```

Или такой вариант с указанием конкретного размера 25G:

```shell
qemu-img resize /путь_до_диска 25G
```

Что происходит после выполнения данной команды? Запускаем сервер и конечно система не грузится:

![qemu-img resize уменьшение диска в kvm ломает файловую систему|800](/Media/Pictures/KVM_Resize_Volume/image_7.png)

Я пробовал сначала уменьшить раздел из-под системы с помощью утилиты fdisk, но в таком случае, система так же перестает загружаться, даже если вы пропустите шаг уменьшения диска с физического сервера и это логично. Раздел который мы уменьшаем, системный и соответственно ОС перестает загружаться, так как при уменьшении диска, информация по всей видимости уничтожается.
### Уменьшение виртуального диска с подменой образа

Уже не такой распространенный в инструкциях вариант — это уменьшение диска, с подменой на старый. То есть, вы создаете новую виртуальную машину с нужным вам размером диска. После чего, подменяете старый образ диска в новый образ и судя по описанию статей в разных источниках, это работает. Я так же сделал проверку и это сломало файловую систему, как и в первом варианте. Я приведу пример команды:

```shell
virt-resize /старый_образ_диска /новый_образ_диска
```

Приводились так же варианты, с конвертацией диска с формата raw в формат qcow2, НО я изначально создаю машины в данном формате и объясню почему.
### Форматы дисков KVM и сжатие диска в qcow2 формате

В самом начале статьи, я упомянул про эти два формата.

**raw** – в переводе «сырой». Преимущество формата, максимальная производительность, универсальность формата. Минусов масса, основные это:

- Диск занимает все дисковое пространство на физическом сервере, которое ему выделили;
- Нельзя создать снапшоты.

**Qcow2** – это родной формат гипервизора QEMU, а так же QEMU-KVM. Это максимально удобный формат виртуального диска из всех поддерживаемых в KVM. Образ диска увеличивается по мере накопления данных на виртуальной машине, поддерживаются снапшоты.

Чем хорош формат qcow2? Вам в принципе не нужно уменьшать размер виртуального диска, так как диск занимает на сервере, ровно столько, сколько места там занято. Если же у вас данные на сервере постоянно перезаписываются и бывает такое, что диск «распух», его можно с легкостью сжать. Рассмотрим такой вариант. Я забью нулями некоторое дисковое пространство и после чего удалю файл:  
```shell
dd if=/dev/zero of=/mytempfile
rm -rf /mytempfile
```

![уменьшение размера диска в kvm через qemu-img convert|600](/Media/Pictures/KVM_Resize_Volume/image_8.png)

При проверке с сервера, образ диска сначала весил 2.4G после чего расширился до 5.9G:
```shell
du -sh /путь_образа
```

`2.4G *****`

```shell
du -sh /путь_образа
```

`5.9G *****`

То есть после удаления информации на виртуальной машине, диск обратно не сжался. Чтобы файл диска получил актуальный размер, я использую следующий метод:

Резервируем файл диска, останавливаем виртуальную машину и после чего выполняем следующие действия:
```shell
qemu-img convert -O qcow2 /старый_образ /новый_образ
```

После чего можно проверить размеры двух дисков:
```shell
du -sh /новый_диск
```

`1.6G /****`

```shell
du -sh /старый_диск
```

`5.8G /****`

Как видим, размер сжатого диска 1.6G. Переименуем новый образ диска в нужный нам и запустим виртуальную машину:
```shell
df -h
```

```
Filesystem Size Used Avail Use% Mounted on
devtmpfs 485M 0 485M 0% /dev
tmpfs 496M 0 496M 0% /dev/shm
tmpfs 496M 6.6M 489M 2% /run
tmpfs 496M 0 496M 0% /sys/fs/cgroup
/dev/vda2 25G 1.3G 24G 6% /
/dev/vda1 488M 100M 353M 23% /boot
tmpfs 100M 0 100M 0% /run/user/0
```

Контрольная проверка с сервера:

`# du -sh /образ_диска`

`1.6G /****`
