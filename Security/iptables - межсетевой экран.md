 2021-08-13  
[Оригинальная статья](https://ruvds.com/ru/helpcenter/iptables/)

```table-of-contents
title: Содержание:
style: nestedList # TOC style (nestedList|inlineFirstLevel)
minLevel: 0 # Include headings from the specified level
maxLevel: 0 # Include headings up to the specified level
includeLinks: true # Make headings clickable
debugInConsole: false # Print debug info in Obsidian console
```
# Межсетевой экран iptables. Основные принципы и понятия.

## Что такое iptables

iptables – это стандартная утилита, управляющая встроенным в ядро брандмауэром netfilter. Более современным инструментом является утилита nftables (включена в ядро Linux с версии 3.13 и призвана заменить iptables, о ней будет отдельная статья). Тем не менее базовая настройка безопасности на многих боевых серверах по-прежнему производится при помощи iptables. Основной принцип его работы (как и остальных файрволов) заключается в применении определенных действий к пакету, проходящему через сетевой интерфейс, в соответствии с определенными правилами.
## Как работает iptables

Общая схема работы такова: пакет приходит на сетевой интерфейс и передается на цепочки, где фильтруется, согласно заданным правилам. Если пакет не отбрасывается в ходе проверки, он передается на исходящий интерфейс (причем в ходе прохождения через iptables он может модифицироваться) или доставляется локальному процессу.
## Основные сущности iptables

Рассмотрим основные сущности iptables:
### Правило (rules)

Правило (rules) это символьная строка, состоящая из критерия, действия и счетчика.  

>**Пример:**
```bash
iptables -A INPUT -p tcp --destination-port 80 -m iprange --src-range 192.168.15.10-192.168.15.50 -j ACCEPT
```

Это правило разрешает подключение к порту 80 (Apache), если адрес находится в диапазоне от 192.168.15.10 – 192.168.15.50. Как читать правила более подробно мы разбираем в следующей статье.
### Критерий

Критерием называется то, что мы хотим проверить в пакете. Несколько критериев соединяются логическим “И”. В приведенном выше примере критерий это _“INPUT -p tcp –destination-port 80 -m iprange –src-range 192.168.15.10-192.168.15.50”_
### Действие (target)

Действие определяет, что будет сделано с пакетом, если он попал под критерий.  
Перечислим наиболее распространенные действия:

- ACCEPT – разрешить пакет
- DROP – отбросить пакет
- QUEUE – передать пакет за пределы iptables (допустим другому процессу или приложению)
- RETURN – вернуться на одно правило назад, остановив обработку текущего правила
- REJECT – отбросить пакет, но с сообщением причины отбрасывания
- LOG – логировать соответствие пакета критериям правила (полезно включать при отладке)

В примере выше действие ACCEPT разрешает прохождение пакета.
### Счетчик

Счетчиком называется компонент, который показывает сколько пакетов в байтах попало под критерий правила. Посмотреть счетчик можно при помощи специального ключа, об этом будет практическая статья.
### Цепочка

Цепочка это набор правил в определенной последовательности. Пакет последовательно проверяется в цепочке до первого соответствия критерию, после “срабатывания” остальные правила в цепочке не проверяются. Цепочки бывают стандартными и пользовательскими.  
Стандартные цепочки:

- PREROUTING — для предварительной обработки входящего трафика
- INPUT — для входящего трафика, приходящего непосредственно на сетевой интерфейс сервера
- FORWARD — цепочка на маршрутизируемый трафик
- OUTPUT — для исходящего трафика
- POSTROUTING— для окончательной фильтрации исходящего трафика

Для всех стандартных цепочек в отличии от пользовательских есть возможность применения _default policy_ (действия по умолчанию) к пакету, если он не попал ни под одно правило цепочки.  
Пользовательские цепочки создаются самим пользователем. Рекомендуем называть эти цепочки именами в нижнем регистре, чтобы избежать путаницы в дальнейшем.
### Таблица

Таблицей является множество цепочек, объединенных по одному функционалу. В iptables имеется 5 стандартных таблиц: _raw, mangle, nat, filter, security._

![|800](/Media/Pictures/iptables/iptables1-1-1024x252.png)
### Состояние

Также в iptables пакет, проходящий через цепочки, имеет определенное состояние (conntrack). Перечислим их:

- NEW — пакет, открывающий новый сеанс. Пример — первый пакет (с флагом SYN) при установке TCP-соединения.
- ESTABLISHED — пакет в существующем сеансе.
- RELATED — пакет, открывающий новый сеанс, который связан с уже открытым сеансом. (пример – обмен пакетами FTP в пассивном режиме).
- INVALID — остальные пакеты.
# Базовая настройка iptables. Пишем первые правила.

**_Замечание:_**  
Для создания правил iptables нам потребуется возможность выполнения команд с повышением привилегий до суперпользователя root. Поэтому для настройки межсетевого экрана нужно зайти в систему под учетной записью root (что не является лучшей практикой с точки зрения безопасности), либо использовать команду sudo перед каждой командой настройки iptables для повышения привилегий пользователя. Мы будем применять второй вариант.
## Основные команды iptables

>Вывод текущих правил в табличном виде выполняется при помощи вызова команды *iptables* с ключом `-L`:
```bash
sudo iptables -L
```

>Вывод:
```
Output:
Chain INPUT (policy ACCEPT)
target prot opt source destination

Chain FORWARD (policy ACCEPT)
target prot opt source destination

Chain OUTPUT (policy ACCEPT)
target prot opt source destination
```

В выводе представлены 3 стандартных цепочки (*INPUT, OUTPUT, FORWARD*) и действие по умолчанию (_default policy_) для каждой цепочки – *ACCEPT*. Как видим, у нас пока нет боевых правил. По умолчанию iptables идет без предустановленных правил и пропускает весь трафик.  

>Вывод текущих настроенных правил в виде строк выполняется при помощи вызова команды *iptables* с ключом `-S`:
```bash
sudo iptables -S
```

Более подробно

>Вывод:
```
Output:
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
```

Ключ `-P` указывает на действие, применяемое к пакету по умолчанию.  
Построчный вывод полезен тем, что каждая строка вывода — это полноценная команда в iptables (например, мы можем получить такой вывод уже на настроенном сервере и использовать его для настройки другого сервера, сделав небольшие правки).  

>Для очистки всех правил используется ключ _-F_:
```bash
sudo iptables -F
```

Тут стоит отметить важность политик по умолчанию, так как они не удалятся после применения этой команды. Поясним подробней. Допустим у нас есть только удаленный доступ к серверу и в политике iptables по умолчанию выставлено действие _DROP_. В результате чего после очистки всех правил повторное подключение к серверу будет невозможно. Поэтому, если у нас нет физического доступа или консольного подключения к серверу, то перед сбросом всех правил необходимо убедиться, что действие по умолчанию – _ACCEPT_. Это позволит нам удаленно подключиться к серверу, создать разрешающее удаленную сессию первое правило. После этого для повышения безопасности можно уже выставить политику по умолчанию – _DROP_.  

>Чтобы задать действие по умолчанию _ACCEPT_ и выполнить последующую очистку правил вводим:
```bash
sudo iptables -P INPUT ACCEPT
sudo iptables -P OUTPUT ACCEPT
sudo iptables -F
```
## Создание первого правила iptables

>Это будет правило, о котором мы говорили выше. Оно позволит принимать текущее SSH-соединение между нами и сервером. Синтаксис команды, добавляющей это правило, следующий:
```bash
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED, RELATED -j ACCEPT
```

На первый взгляд выглядит запутанно. Разберем подробней команду:

- `-A INPUT`: флаг _-A_ (append) – добавляет правило в конец цепочки _INPUT_
- `-m conntrack`: этот параметр вызывает модуль _conntrack_ для отслеживания информации о соединениях.
- `–ctstate ESTABLISHED, RELATED`: выделяем все соединения в состоянии _ESTABLISHED_ (выделяется трафик по уже существующим соединениям) и _RELATED_ (трафик по новым соединениям, но связанных с уже открытыми).
- `-j ACCEPT`: действие (target) – то, что будет произведено с пакетом, если он попал под критерий. В нашем случае это _ACCEPT_.

>После применения этого правила можем увидеть изменения в выводе:
```bash
sudo iptables -L
```

>Вывод:
```
Output:
Chain INPUT (policy ACCEPT)
target prot opt source destination
ACCEPT all -- anywhere anywhere ctstate RELATED,ESTABLISHED

Chain FORWARD (policy ACCEPT)
target prot opt source destination

Chain OUTPUT (policy ACCEPT)
target prot opt source destination
```

Теперь мы можем менять действия в политике по умолчанию на _DROP_.
## Другие правила iptables

Добавим еще два правила, разрешающие [SSH](https://www.openssh.com/manual.html)-соединения (по умолчанию на 22 порт) и WEB-подключения на 80 порт.  

>Приведем синтаксис этих правил:
```bash
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
```

Разберем новые параметры:

- `-p tcp`: фильтруем пакеты, использующие протокол TCP
- `–dport`: выделяем TCP-пакеты с портом назначения 22 и 80.

Также есть еще одно правило, которое связано с понятием “петли” (loopback-интерфейса). Используется loopback-интерфейс для взаимодействия служб и приложений в пределах одной локальной системы, без надобности отправления пакетов на сетевой интерфейс.  

>Правило выглядит так:
```bash
sudo iptables -I INPUT 1 -i lo -j ACCEPT
```

Разберем его:

- Ключ `-I` (insert) указывает вставить правило в цепочку на 1-ое место. Порядковый номер вставки указывается за именем цепочки _INPUT_ (напоминаем, что флаг -A добавляет правило в конец)
- `-i lo` – указываем интерфейс _loopback_ и разрешаем трафик через него.

Мы составили 4 правила, на основании которых iptables будет разрешать трафик на сервер. Но поскольку мы не создали ни одного запрещающего правила, то все соединения с сервером будут по-прежнему разрешены.  
Есть два способа реализации блокирования нежелательного трафика:

1. Политика запрета по умолчанию.

>Достигается написанием правила:
```bash
sudo iptables -P INPUT DROP
```

Тут надо помнить об опасности потери удаленного доступа к серверу. Желательно его применять, когда есть консольный доступ к серверу.

2. Добавление запрещающего правила в конец цепочки.

```bash
sudo iptables -A INPUT -j DROP
```

>Тут уже нет опасности потери удаленного подключения к серверу, но есть особенность добавления правил. Новые правила необходимо добавлять в цепочку перед запрещающим правилом. Достигается это путем ввода набора из трех правил: удаление запрещающего правила, добавление нового правила, добавление запрещающего правила в конец.
```bash
sudo iptables -D INPUT -j DROP
sudo iptables -A INPUT "MY_NEW_RULE"
sudo iptables -A INPUT -j DROP
```

>Также можно вставить новое правило до запрещающего правила, используя порядковый номер. Для этого сперва узнаем нумерацию имеющихся правил:
```bash
sudo iptables -L --line-numbers
```

>Потом на основании вывода вставляем правило под нужным порядковым номером:
```bash
sudo iptables -I INPUT 4 "MY_NEW_RULE"
```
## Сохранение правил iptables

По умолчанию правила iptables не хранятся в постоянной памяти и сбрасываются после перезагрузки. С одной стороны это может быть удобно, в случае потери SSH-подключения к серверу. С другой — часто важна автоматическая загрузка составленных правил после перезагрузки сервера. Один из способов сохранения правил — использование пакета **_iptables-persistent_**.  
Он стандартно устанавливается из репозиториев [Ubuntu](https://ubuntu.com/download):

```bash
sudo apt-get update
sudo apt-get install iptables-persistent
```

>Во время установки **_iptables-persistent_** попросит подтверждение о сохранении имеющихся правил. Если в последующем мы изменили или добавили правила, то сохраняем их:
```bash
sudo invoke-rc.d iptables-persistent save
```
# Примеры вывода и удаления правил

## Введение

В предыдущей [статье](https://ruvds.com/ru/helpcenter/configure-iptables/) мы изучили основные команды файрвола iptables и написали первые правила. В этой статье мы продолжим знакомство с утилитой iptables, необходимой для настройки межсетевого экрана в большинстве операционных систем Linux. Утилита управляет встроенным в ядро брендмауэром netfilter. Netfilter является важным компонентом в обеспечении сетевой безопасности ОС семейства Linux. Более подробно об основных понятиях iptables вы можете почитать [тут](https://ruvds.com/ru/helpcenter/iptables/). В статье рассмотрим, как выводить, читать правила iptables, а также удалять их. Что будет освящено в этой статье:

- вывод списка правил iptables
- сброс счетчиков iptables
- удаление правила
- удаление цепочки правил

Все действия будем проводить в ОС [Ubuntu 20.04](https://releases.ubuntu.com/20.04/).
## Вывод списка правил iptables

Утилита iptables позволяет нам выводить список правил в двух форматах – в построчном и табличном.
### Построчный вывод

>Для вывода правил в виде последовательности строк используем команду:
```bash
sudo iptables -S
```

>В зависимости от имеющихся на сервере правил вывод может отличаться. В нашем случае он такой:
```
-P INPUT DROP
-P FORWARD DROP
-P OUTPUT ACCEPT
-N ICMP
-N TCP
-N UDP
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
```

>Если нам надо отфильтровать вывод и вывести, например, все правила iptables, регламентирующие установление TCP-соединений, используем команду:
```bash
sudo iptables -S TCP
```
### Табличный вывод

>Для табличного вывода вызываем утилиту с ключом `-L`:
```bash
sudo iptables -L
```

>Вывод:
```
Chain INPUT (policy ACCEPT)
target prot opt source destination
ПРАВИЛА ЦЕПОЧКИ INPUT
Chain FORWARD (policy ACCEPT)
target prot opt source destination
ПРАВИЛА ЦЕПОЧКИ FORWARD
Chain OUTPUT (policy ACCEPT)
target prot opt source destination
ПРАВИЛА ЦЕПОЧКИ OUTPUT 
```

В выводе видим все правила, разбитые в блоки по цепочкам.Как видим, вывод в виде таблицы более информативный и удобен для чтения.  

>Чтобы вывести правила конкретной цепочки, указываем ее имя после команды. Получим все правила базовой цепочки INPUT:
```bash
sudo iptables -L INPUT
```

>Вывод:  
```
Chain INPUT (policy DROP)
num  target     prot opt source               destination
1    ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
2    ACCEPT     all  --  anywhere             anywhere
3    DROP       all  --  anywhere             anywhere             ctstate INVALID
4    UDP        udp  --  anywhere             anywhere             ctstate NEW
5    TCP        tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN ctstate NEW
6    ICMP       icmp --  anywhere             anywhere             ctstate NEW
7    REJECT     udp  --  anywhere             anywhere             reject-with icmp-port-unreachable
7    REJECT     tcp  --  anywhere             anywhere             reject-with tcp-reset
7    REJECT     all  --  anywhere             anywhere             reject-with icmp-port-unreachable
```


Давайте на этом примере рассмотрим, как читать эти правила.  
Сперва идет имя самой цепочки – в нашем случае это INPUT. Цепочка может быть **базовой** (PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING) и **пользовательской** (имя цепочки задается самим пользователем). После следует политика, применяемая к этой цепочке по умолчанию – DROP. Далее непосредственно сами правила, разбитые по заголовкам. Рассмотрим эти заголовки:

- **_target_**: тут указано основное действие, которое будет применено к пакету, если он попал под это правило. Базовые действия, доступные для всех цепочек: ACCEPT (разрешить), DROP (отбросить), QUEUE (перенаправить на анализ внешней утилите), и RETURN (вернуть на предыдущую цепочку).
- **_prot_**: анализируемый сетевой протокол. Если необходимо проверять трафик по все протоколам – указываем all.
- **_opt_**: в этом столбце указываются дополнительные параметры IP
- **_source_**: IP-адрес или подсеть отправителя (anywhere – отправитель с любым адресом)
- **_destination_**: IP-адрес или подсеть получателя (anywhere – любой адрес получателя)
- последний столбец без названия необходим для указания дополнительных опций правила (уточнение номера порта, сброс состояния и т.п.)
## Сброс счетчика пакетов и их размера

Для начала разберем как вывести эти параметры, а потом рассмотрим, как их сбросить и для чего это делается.  
Чтобы вывести сколько пакетов попали под конкретное правило и их суммарный размер используем команду:

```bash
sudo iptables -L INPUT -v
```

>Вывод команды:
```
pkts bytes target     prot opt in     out     source               destination            
17067 1005K TCP        tcp  --  any    any     anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN ctstate NEW
 2410  154K ICMP       icmp --  any    any     anywhere             anywhere             ctstate NEW
  396 63275 REJECT     udp  --  any    any     anywhere             anywhere             reject-with icmp-port-unreachable
```

>Непосредственно сам сброс счетчиков выполняется командой:
```bash
sudo iptables -Z INPUT
```

>Если хотим сбросить счетчик только для первого правила цепочки используем:
```bash
sudo iptables -Z INPUT 1
```

>Для обнуления счетчиков и размера для всех цепочек и каждого правила:
```bash
sudo iptables -Z
```

Сброс счетчиков может быть полезен, если необходимо узнать приходит ли попадающий под правила новый трафик на [сервер](https://ruvds.com/cheap_vps/) или нет. По умолчанию все счетчики сбрасываются после перезагрузки системы.
## Удаление правил iptables

Приведем различные способы удаления правил iptables.
### Удаление по имени правила.

>В этом случае используется ключ -D после которого следует имя правила в виде строки. Имя правила узнаем при помощи команды, рассмотренной выше:
```bash
sudo iptables -S
```

>Допустим в данном выводе мы нашли правило
```
-A INPUT -i eth0 -p tcp --dport 443 -j ACCEPT
```

и которое подлежит удалению.  

>Для этого введем:
```bash
iptables -D INPUT -i eth0 -p tcp --dport 443 -j ACCEPT
```

Обратите внимание, что ключ -A при удалении правила не указывается.
### Удаление по номеру правила в цепочке.

>Для удаления этим способом нам необходимо знать название цепочки, к которой принадлежит правило и его порядковый номер в ней. Все это определяется командой:
```bash
sudo iptables -L --line-numbers
```

>Вывод:
```
Chain INPUT (policy DROP)
num  target     prot opt source               destination
1    ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
2    ACCEPT     all  --  anywhere             anywhere
3    DROP       all  --  anywhere             anywhere             ctstate INVALID
4    UDP        udp  --  anywhere             anywhere             ctstate NEW
5    TCP        tcp  --  anywhere             anywhere             tcp flags:FIN,SYN,RST,ACK/SYN ctstate NEW
6    ICMP       icmp --  anywhere             anywhere             ctstate NEW
7    REJECT     udp  --  anywhere             anywhere             reject-with icmp-port-unreachable
```

>И само удаление:
```bash
sudo iptables -D ИМЯ ЦЕПОЧКИ НОМЕР
```

>Например, удалим привило с номером 5 в цепочке INPUT:
```bash
sudo iptables -D INPUT 5
```
### Удаление всех правил iptables

>Мы можем удалить все правила в пределах одной цепи. Для этого используется ключ -F. Например, удалим все правила цепочки INPUT:
```bash
sudo iptables -F INPUT
```

>Для удаления правил во всех цепочках вводим команду:
```bash
sudo iptables -F
```
