`fail2ban` — это инструмент, который помогает защитить ваш сервер от брутфорс-атак, автоматически блокируя IP-адреса, которые совершают много неудачных попыток входа. Вот пошаговая инструкция по установке и настройке `fail2ban` на Ubuntu Server.

### 1. Установка fail2ban

Сначала обновите список пакетов и установите `fail2ban`:
```bash
sudo apt-get update
sudo apt-get install fail2ban
```

### 2. Настройка fail2ban

После установки `fail2ban`, вам нужно настроить его для защиты вашего сервера. Основной конфигурационный файл находится в `/etc/fail2ban/jail.conf`. Однако рекомендуется создать локальный файл конфигурации, чтобы избежать потери настроек при обновлении `fail2ban`.

Создайте копию файла конфигурации:
```bash
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

Теперь откройте файл `jail.local` для редактирования:
```bash
sudo nano /etc/fail2ban/jail.local
```

### 3. Настройка защиты SSH

Найдите раздел `[sshd]` и убедитесь, что он включен:
```
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
```

ubuntu
```
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = %(sshd_log)s
backend = systemd
bantime = 3600
```

- `enabled = true`: Включает защиту для SSH.  
- `port = ssh`: Указывает порт, на котором работает SSH. Если вы используете другой порт, укажите его здесь.  
- `filter = sshd`: Указывает фильтр, который будет использоваться для анализа логов.  
- `logpath = /var/log/auth.log`: Указывает путь к файлу логов, где `fail2ban` будет искать неудачные попытки входа.  
- `maxretry = 3`: Количество неудачных попыток входа, после которых IP-адрес будет заблокирован.  
- `bantime = 3600`: Время блокировки IP-адреса в секундах (в данном случае 1 час).
### 4. Дополнительные настройки

Вы можете настроить другие службы, которые вы хотите защитить, например, веб-сервер Apache или Nginx. Для этого добавьте соответствующие разделы в файл `jail.local`.

Пример настройки для Apache:

```
[apache]
enabled = true
port = http,https
filter = apache-auth
logpath = /var/log/apache*/*error.log
maxretry = 3
bantime = 3600
```

### 5. Перезапуск fail2ban

После внесения изменений перезапустите `fail2ban`, чтобы применить новые настройки:
```bash
sudo systemctl restart fail2ban
```

### 6. Проверка статуса fail2ban

Вы можете проверить статус `fail2ban`, чтобы убедиться, что он работает корректно:
```bash
sudo fail2ban-client status
```

Эта команда покажет список активных тюрем (jails). Чтобы увидеть статус конкретной тюрьмы, например, `sshd`, используйте:
```bash
sudo fail2ban-client status sshd
```

### 7. Разблокировка IP-адреса

Если вы заблокировали IP-адрес по ошибке или хотите разблокировать его вручную, используйте следующую команду:

```bash
sudo fail2ban-client set sshd unbanip 103.190.29.142
```
*Замените `103.190.29.142` на IP-адрес, который вы хотите разблокировать.*

### Заключение

Теперь `fail2ban` настроен и будет автоматически блокировать IP-адреса, которые совершают много неудачных попыток входа на ваш сервер. Это поможет защитить ваш сервер от брутфорс-атак и других попыток несанкционированного доступа.