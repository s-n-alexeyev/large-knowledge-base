2020-10-05

[Оригинальная статья](https://itsecforu.ru/2020/10/05/%F0%9F%94%90-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B2%D1%85%D0%BE%D0%B4%D0%B0-%D0%BF%D0%BE-ssh-%D0%B1%D0%B5%D0%B7-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%BD/#vhod-na-udalennyy-server-linux-bez-parolya)

![Создание SSH ключа, настройка SSH-сервера, клиента, проброс портов](https://www.youtube.com/watch?v=dy_XaQOJnPw)

Аутентификация на основе ключей SSH (также известная как аутентификация с открытым ключом) позволяет использовать аутентификацию без пароля, и это более безопасное и гораздо лучшее решение, чем аутентификация по паролю.  
[🐧 Как определить использует ли пользователь SSH-аутентификацию на основе пароля или ключа](https://itsecforu.ru/2020/05/11/%f0%9f%90%a7-%d0%ba%d0%b0%d0%ba-%d0%be%d0%bf%d1%80%d0%b5%d0%b4%d0%b5%d0%bb%d0%b8%d1%82%d1%8c-%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d1%83%d0%b5%d1%82-%d0%bb%d0%b8-%d0%bf%d0%be%d0%bb%d1%8c%d0%b7/)

Одним из основных преимуществ входа в систему без пароля по SSH, не говоря уже о безопасности, является то, что он позволяет автоматизировать различные виды межсерверных процессов. 
[🔬 Как обменяться ключом SSH для аутентификации без пароля между серверами Linux](https://itsecforu.ru/2019/07/24/%f0%9f%94%8f-%d0%ba%d0%b0%d0%ba-%d0%be%d0%b1%d0%bc%d0%b5%d0%bd%d1%8f%d1%82%d1%8c%d1%81%d1%8f-%d0%ba%d0%bb%d1%8e%d1%87%d0%be%d0%bc-ssh-%d0%b4%d0%bb%d1%8f-%d0%b0%d1%83%d1%82%d0%b5%d0%bd%d1%82%d0%b8/)

В этой статье мы продемонстрируем, как создать пару ключей SSH и скопировать открытый ключ на несколько удаленных хостов Linux одновременно с помощью скрипта оболочки.
## Создание нового ключа SSH на Linux

>Сначала создайте пару ключей SSH (закрытый ключ / ключ идентификации, который SSH-клиент использует для аутентификации при входе на удаленный SSH-сервер, и открытый ключ, хранящийся в качестве авторизованного ключа в удаленной системе, на которой запущен SSH-сервер), используя ssh- keygen следующим образом:
```shell
ssh-keygen
```

![|500](/Media/Pictures/SSH_Auth/image_1.png)
### Создание скрипта bash для нескольких удаленных входов

>Затем создайте скрипт, который поможет скопировать открытый ключ на несколько удаленных хостов Linux.
```shell
vim ~/.bin/ssh-copy.sh
```

>Скопируйте и вставьте следующий код в файл (замените следующие переменные соответственно USER_NAME – имя пользователя для подключения, HOST_FILE – файл, содержащий список имен хостов или IP-адресов, и ERROR_FILE – файл для хранения любых ошибок команды ssh).
```shell
#!/bin/bash
USER_NAME="root"
HOST_FILE="/root/hosts"
ERROR_FILE="/tmp/ssh-copy_error.txt"
PUBLIC_KEY_FILE="$1"

if [ ! -f  $PUBLIC_KEY_FILE ]; then
        echo "File '$PUBLIC_KEY_FILE' не найден!"
        exit 1
fi

if [ ! -f $HOST_FILE ]; then
        echo "File '$HOST_FILE' не найден!"
        exit 2
fi

for IP in `cat $HOST_FILE`; do
        ssh-copy-id -i $PUBLIC_KEY_FILE $USER_NAME@$IP 2>$ERROR_FILE
        RESULT=$?
        if [ $RESULT -eq 0 ]; then
                echo ""
                echo "Открытый ключ успешно скопирован на $IP"
                echo ""
        else
                echo "$(cat  $ERROR_FILE)"
                echo 
                exit 3
        fi
        echo ""
done
```

Сохраните файл и закройте его.

>Затем сделайте скрипт исполняемым с помощью команды chmod, как показано далее:  
```shell
chmod +x ssh-copy.sh
```

>Теперь запустите скрипт ssh-copy.sh и укажите свой файл открытого ключа в качестве первого аргумента, как показано ниже:
```shell
./ssh-copy.sh /root/.ssh/prod-rsa.pub
```

Затем используйте ssh-agent для управления своими ключами, который хранит ваш расшифрованный закрытый ключ в памяти и использует его для аутентификации логинов.

>После запуска ssh-agent добавьте к нему свой закрытый ключ следующим образом:
```shell
eval "$(ssh-agent -s)"
ssh-add  ~/.ssh/prod_rsa
```
### Вход на удаленный сервер Linux без пароля

Теперь вы можете войти на любой из своих удаленных хостов, не вводя пароль для аутентификации пользователя SSH.  
Таким образом, вы можете автоматизировать межсерверные процессы.

>Пример
```shell
ssh root@10.2.32.12
```
