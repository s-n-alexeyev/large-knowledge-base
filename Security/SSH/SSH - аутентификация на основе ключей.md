2020-10-05

[ÐžÑ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ð°Ñ‚ÑŒÑ](https://itsecforu.ru/2020/10/05/%F0%9F%94%90-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B2%D1%85%D0%BE%D0%B4%D0%B0-%D0%BF%D0%BE-ssh-%D0%B1%D0%B5%D0%B7-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%BD/#vhod-na-udalennyy-server-linux-bez-parolya)

![Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ SSH ÐºÐ»ÑŽÑ‡Ð°, Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH-ÑÐµÑ€Ð²ÐµÑ€Ð°, ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°, Ð¿Ñ€Ð¾Ð±Ñ€Ð¾Ñ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²](https://www.youtube.com/watch?v=dy_XaQOJnPw)

ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ»ÑŽÑ‡ÐµÐ¹ SSH (Ñ‚Ð°ÐºÐ¶Ðµ Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ°Ðº Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼ ÐºÐ»ÑŽÑ‡Ð¾Ð¼) Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ, Ð¸ ÑÑ‚Ð¾ Ð±Ð¾Ð»ÐµÐµ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ðµ Ð¸ Ð³Ð¾Ñ€Ð°Ð·Ð´Ð¾ Ð»ÑƒÑ‡ÑˆÐµÐµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ, Ñ‡ÐµÐ¼ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð¿Ð¾ Ð¿Ð°Ñ€Ð¾Ð»ÑŽ.  
[ðŸ§ ÐšÐ°Ðº Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ SSH-Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¸Ð»Ð¸ ÐºÐ»ÑŽÑ‡Ð°](https://itsecforu.ru/2020/05/11/%f0%9f%90%a7-%d0%ba%d0%b0%d0%ba-%d0%be%d0%bf%d1%80%d0%b5%d0%b4%d0%b5%d0%bb%d0%b8%d1%82%d1%8c-%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d1%83%d0%b5%d1%82-%d0%bb%d0%b8-%d0%bf%d0%be%d0%bb%d1%8c%d0%b7/)

ÐžÐ´Ð½Ð¸Ð¼ Ð¸Ð· Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð¿Ñ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð² Ð²Ñ…Ð¾Ð´Ð° Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¿Ð¾ SSH, Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ñ ÑƒÐ¶Ðµ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð¾Ð½ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð²Ð¸Ð´Ñ‹ Ð¼ÐµÐ¶ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð². 
[ðŸ”¬ ÐšÐ°Ðº Ð¾Ð±Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ ÐºÐ»ÑŽÑ‡Ð¾Ð¼ SSH Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ Ð¼ÐµÐ¶Ð´Ñƒ ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼Ð¸ Linux](https://itsecforu.ru/2019/07/24/%f0%9f%94%8f-%d0%ba%d0%b0%d0%ba-%d0%be%d0%b1%d0%bc%d0%b5%d0%bd%d1%8f%d1%82%d1%8c%d1%81%d1%8f-%d0%ba%d0%bb%d1%8e%d1%87%d0%be%d0%bc-ssh-%d0%b4%d0%bb%d1%8f-%d0%b0%d1%83%d1%82%d0%b5%d0%bd%d1%82%d0%b8/)

Ð’ ÑÑ‚Ð¾Ð¹ ÑÑ‚Ð°Ñ‚ÑŒÐµ Ð¼Ñ‹ Ð¿Ñ€Ð¾Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼, ÐºÐ°Ðº ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ñƒ ÐºÐ»ÑŽÑ‡ÐµÐ¹ SSH Ð¸ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ…Ð¾ÑÑ‚Ð¾Ð² Linux Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¾Ð±Ð¾Ð»Ð¾Ñ‡ÐºÐ¸.
## Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð° SSH Ð½Ð° Linux

>Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ð°Ñ€Ñƒ ÐºÐ»ÑŽÑ‡ÐµÐ¹ SSH (Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ / ÐºÐ»ÑŽÑ‡ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ SSH-ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ SSH-ÑÐµÑ€Ð²ÐµÑ€, Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡, Ñ…Ñ€Ð°Ð½ÑÑ‰Ð¸Ð¹ÑÑ Ð² ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð° Ð² ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ SSH-ÑÐµÑ€Ð²ÐµÑ€), Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ ssh- keygen ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼:
```shell
ssh-keygen
```

![|500](/Media/Pictures/SSH_Auth/image_1.png)
### Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° bash Ð´Ð»Ñ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð²Ñ…Ð¾Ð´Ð¾Ð²

>Ð—Ð°Ñ‚ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ…Ð¾ÑÑ‚Ð¾Ð² Linux.
```shell
vim ~/.bin/ssh-copy.sh
```

>Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ¾Ð´ Ð² Ñ„Ð°Ð¹Ð» (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ USER_NAME â€“ Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ, HOST_FILE â€“ Ñ„Ð°Ð¹Ð», ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð¼ÐµÐ½ Ñ…Ð¾ÑÑ‚Ð¾Ð² Ð¸Ð»Ð¸ IP-Ð°Ð´Ñ€ÐµÑÐ¾Ð², Ð¸ ERROR_FILE â€“ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð»ÑŽÐ±Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ssh).
```shell
#!/bin/bash
USER_NAME="root"
HOST_FILE="/root/hosts"
ERROR_FILE="/tmp/ssh-copy_error.txt"
PUBLIC_KEY_FILE="$1"

if [ ! -f  $PUBLIC_KEY_FILE ]; then
        echo "File '$PUBLIC_KEY_FILE' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
        exit 1
fi

if [ ! -f $HOST_FILE ]; then
        echo "File '$HOST_FILE' Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
        exit 2
fi

for IP in `cat $HOST_FILE`; do
        ssh-copy-id -i $PUBLIC_KEY_FILE $USER_NAME@$IP 2>$ERROR_FILE
        RESULT=$?
        if [ $RESULT -eq 0 ]; then
                echo ""
                echo "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð½Ð° $IP"
                echo ""
        else
                echo "$(cat  $ERROR_FILE)"
                echo 
                exit 3
        fi
        echo ""
done
```

Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð¸ Ð·Ð°ÐºÑ€Ð¾Ð¹Ñ‚Ðµ ÐµÐ³Ð¾.

>Ð—Ð°Ñ‚ÐµÐ¼ ÑÐ´ÐµÐ»Ð°Ð¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ chmod, ÐºÐ°Ðº Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½Ð¾ Ð´Ð°Ð»ÐµÐµ:  
```shell
chmod +x ssh-copy.sh
```

>Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ ssh-copy.sh Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ñ„Ð°Ð¹Ð» Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð³Ð¾ ÐºÐ»ÑŽÑ‡Ð° Ð² ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°, ÐºÐ°Ðº Ð¿Ð¾ÐºÐ°Ð·Ð°Ð½Ð¾ Ð½Ð¸Ð¶Ðµ:
```shell
./ssh-copy.sh /root/.ssh/prod-rsa.pub
```

Ð—Ð°Ñ‚ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ssh-agent Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ²Ð¾Ð¸Ð¼Ð¸ ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ Ð²Ð°Ñˆ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÐµÐ³Ð¾ Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¸Ð½Ð¾Ð².

>ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ssh-agent Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ðº Ð½ÐµÐ¼Ñƒ ÑÐ²Ð¾Ð¹ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼:
```shell
eval "$(ssh-agent -s)"
ssh-add  ~/.ssh/prod_rsa
```
### Ð’Ñ…Ð¾Ð´ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Linux Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²Ð¾Ð¹Ñ‚Ð¸ Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¹ Ð¸Ð· ÑÐ²Ð¾Ð¸Ñ… ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ñ… Ñ…Ð¾ÑÑ‚Ð¾Ð², Ð½Ðµ Ð²Ð²Ð¾Ð´Ñ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ SSH.  
Ð¢Ð°ÐºÐ¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¼ÐµÐ¶ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹.

>ÐŸÑ€Ð¸Ð¼ÐµÑ€
```shell
ssh root@10.2.32.12
```
