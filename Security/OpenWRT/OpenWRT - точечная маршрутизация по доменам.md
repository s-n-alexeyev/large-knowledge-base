2023-10-14
[–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è](https://habr.com/ru/articles/767464/)
# –¢–æ—á–µ—á–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω–∞–º –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ —Å OpenWrt
```table-of-contents
title: –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
style: nestedList # TOC style (nestedList|inlineFirstLevel)
minLevel: 0 # Include headings from the specified level
maxLevel: 0 # Include headings up to the specified level
includeLinks: true # Make headings clickable
debugInConsole: false # Print debug info in Obsidian console
```

–°—Ç–∞—Ç—å—è –æ —Ç–æ–º, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–æ—á–µ—á–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ –ø–æ –Ω—É–∂–Ω—ã–º –¥–æ–º–µ–Ω–∞–º –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ —Å OpenWrt. –ù–∞ –º–æ–π –≤–∑–≥–ª—è–¥, —ç—Ç–æ —Å–∞–º—ã–π —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å.  
–Ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é —É–∂–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Å —Å–∞–º—ã–º–∏ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å.  
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—É—Ç–µ—Ä –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –∑–∞–≤–µ–¥—ë—Ç—Å—è —Å—Ä–∞–∑—É, —Ç–æ –¥—Ä—É–≥–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏, —á—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å –ø–æ–º–æ—â—å—é Ansible –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–ª–∞—Å—å, —Ç–æ–ª—å–∫–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞—Å—å –∏ —Å—Ç–∞–ª–∞ –ª—É—á—à–µ.  
–ü–æ–º–∏–º–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ç—É–Ω–Ω–µ–ª–µ–π Wireguard –∏ OpenVPN, –Ω–∞–ø–∏—Å–∞–ª –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π Shadowsocks, VLESS –∏ –ø—Ä–æ—á–∏–º–∏.  
–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞ –ø–æ–¥ —Å–≤–µ–∂—É—é OpenWrt 23.05 –∏ —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –Ω–µ–π. –ù–æ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë –≤—Ä—É—á–Ω—É—é, –ª–∏–±–æ —Å –ø–æ–º–æ—â—å—é¬†[Ansible](https://github.com/itdoginfo/domain-routing-openwrt). –ù–∞ –Ω–∏—Ö –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø–∏—Å–∞–Ω—ã –≤ –ø–µ—Ä–≤–æ–π¬†[—Å—Ç–∞—Ç—å–µ](https://habr.com/ru/articles/440030/).
## –í–∏–¥–µ–æ–≤–µ—Ä—Å–∏—è

![](https://www.youtube.com/watch?v=Otv-kMzGOSU&t=515s)
## –ó–∞—á–µ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ —Å–ø–∏—Å–∫–∞–º

–î—É–º–∞—é, –≤ 2023 –≥–æ–¥—É –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π —Å–∞–º–∏ –º–æ–≥—É—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å. –ù–æ —Å–ø–∏—Å–æ–∫ –ª–∏—à–Ω–∏–º –Ω–µ –±—É–¥–µ—Ç:

- –ï—Å—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Å–∞–π—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø —Å –Ω–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö IP-–∞–¥—Ä–µ—Å–æ–≤. –£–≤–µ—Ä–µ–Ω, –≤—ã —Å —ç—Ç–∏–º —Å—Ç–∞–ª–∫–∏–≤–∞–ª–∏—Å—å  
- –í—ã—Å–æ–∫–∏–π Latency, –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ—Å—É—Ä—Å–∞. –ï—Å–ª–∏ –≤—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –ú–æ—Å–∫–≤–µ, –∞ —Å–µ—Ä–≤–µ—Ä —Å —Å–∞–π—Ç–æ–º –≤ –ü–æ–¥–º–æ—Å–∫–æ–≤—å–µ, —Ç–æ —É –≤–∞—Å –∫–æ—Ä–æ—Ç–∫–∏–π –º–∞—Ä—à—Ä—É—Ç. –ß–µ—Ä–µ–∑ VPN –¥–µ–ª–∞–µ—Ç—Å—è –ø–µ—Ç–ª—è —á–µ—Ä–µ–∑ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω—É. –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–∞  
- –°–∞–π—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –≤–∞—à—É –ª–æ–∫–∞—Ü–∏—é –ø–æ —Å—Ç—Ä–∞–Ω–µ, –≥–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω VPN-—Å–µ—Ä–≤–µ—Ä. –ù–∞–ø—Ä–∏–º–µ—Ä, –≥—É–≥–ª –≤–∞—Å –±—É–¥–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ-–Ω–µ–º–µ—Ü–∫–∏. –ù—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ª–æ–∫–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–± –¥–µ–ª–∞—Ç—å –ø–æ–∏—Å–∫ –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–º —Ä–µ—Å—É—Ä—Å–∞–º  
- –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ –±—ã—Å—Ç—Ä—ã–π VPN-—Å–µ—Ä–≤–µ—Ä, —Ç–æ –≤—Å–µ –≤–∞—à–∏ –≥–∏–≥–∞–±–∏—Ç—ã –ø–æ –æ–ø—Ç–∏–∫–µ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ç—ã–∫–≤—É. VPN —Å–æ–∑–¥–∞—ë—Ç –±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ  
- –Æ—Ä–∏—Å–¥–∏–∫—Ü–∏—è –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω—ã. –ù–∞–ø—Ä–∏–º–µ—Ä, —É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∞–≤–æ–æ–±–ª–∞–¥–∞—Ç–µ–ª–µ–π –ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–æ—Ç–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑–¥–∞—á –Ω–µ–ª–µ–≥–∞–ª—å–Ω—ã—Ö –∫–æ–ø–∏–π –∏—Ö –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ –≤–ª–∞–¥–µ–ª–µ—Ü VPN-—Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–ª—É—á–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∞–±—É–∑—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –≤—ã—Ç–µ–∫–∞—é—â–∏–µ –∏–∑ –Ω–µ—ë –ø—Ä–æ–±–ª–µ–º—ã  
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∞–º VPN-—Å–µ—Ä–≤–µ—Ä. –û–± —ç—Ç–æ –º–∞–ª–æ –∑–∞–¥—É–º—ã–≤–∞—é—Ç—Å—è. –¢–æ—á–µ—á–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ - –∂–∏—Ä–Ω—ã–π –ø–ª—é—Å –¥–ª—è VPN-—Å–µ—Ä–≤–µ—Ä–∞

## –ü—Ä–æ–±–ª–µ–º—ã –≥–æ—Ç–æ–≤—ã—Ö —Å–ø–∏—Å–∫–æ–≤ IP-–∞–¥—Ä–µ—Å–æ–≤

–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - —ç—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –≤–∞–º —Ä–µ—Å—É—Ä—Å–∞ –≤ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–∞—Ö. –ö–∞–∫ —ç—Ç–æ —Ä–µ—à–∞—Ç—å? –ú–æ–∂–Ω–æ —Ä–µ–∑–æ–ª–≤–∏—Ç—å –¥–æ–º–µ–Ω—ã, –ø–æ–ª—É—á–∞—Ç—å IP-–∞–¥—Ä–µ—Å–∞ —Ä–µ—Å—É—Ä—Å–∞ –∏ –∑–∞–Ω–æ—Å–∏—Ç—å –∏—Ö –≤ —Å–≤–æ–π –µ—â—ë –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫. –°–æ –≤—Ä–µ–º–µ–Ω–µ–º —ç—Ç–∏ IP-–∞–¥—Ä–µ—Å–∞ –º–µ–Ω—è—é—Ç—Å—è –∏ –ø—Ä–∏–¥—ë—Ç—Å—è –¥–µ–ª–∞—Ç—å –ø–æ –Ω–æ–≤–æ–π.

Antifilter –ø–æ—Å—Ç–∞—Ä–∞–ª–∏—Å—å —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–º–æ—â—å—é¬†[—Åommunity —Å–ø–∏—Å–∫–∞](https://community.antifilter.download/). –ß—Ç–æ–± –∫–∞–∂–¥—ã–π –º–æ–≥ –¥–æ–±–∞–≤–∏—Ç—å –Ω—É–∂–Ω—ã–π –µ–º—É —Å–∞–π—Ç. –ï—Å—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –∏ —Å–ø–∏—Å–æ–∫ IP-–∞–¥—Ä–µ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥ –¥–æ–º–µ–Ω–æ–≤. –ö—Ä—É—Ç–∞—è –∏–¥–µ—è, –Ω–æ –º–Ω–æ–≥–∏—Ö –¥–æ–º–µ–Ω–æ–≤ –Ω–µ—Ç, –∞ –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ —Ñ–∞–∫—Ç, —á—Ç–æ –±—É–¥–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–æ. –ö–∞–∫ —è –ø–æ–Ω–∏–º–∞—é, —Ä–µ–∑–æ–ª–≤–∏–Ω–≥ –¥–æ–º–µ–Ω–æ–≤ –≤ —Å–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –∏–∑ –æ–¥–Ω–æ–π –ª–æ–∫–∞—Ü–∏–∏, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –±—ã–≤–∞–µ—Ç —Ç–∞–∫, —á—Ç–æ –∞–¥—Ä–µ—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è —É –≤–∞—Å, –±—É–¥–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–ø–∏—Å–∫–∞—Ö.

–í—Ç–æ—Ä–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∫–∞—Å–∞–µ—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ OpenWrt. –í 22–æ–π –≤–µ—Ä—Å–∏–∏ —Å–æ–≤–µ—Ä—à–∏–ª—Å—è –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç iptables –∫ nftables. Nftables sets –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏, —á–µ–º ipset. –ë–æ–ª—å—à–∏–µ —Å–ø–∏—Å–∫–∏ IP-–∞–¥—Ä–µ—Å–æ–≤ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–∞—Ö —Å –Ω–µ–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ —Å—Ç–∞–ª–∏ –≤—ã–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É:

```
netlink: Error: Could not process rule: No buffer space available
The rendered ruleset contains errors, not doing firewall restart.
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏. –ï—Å–ª–∏ —ç—Ç–∞ –æ—à–∏–±–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–µ—Ä–≤–æ–ª–∞ (—Ç—É—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å nftables, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É, –∞ –∂–¥—É—Ç –ø–æ–ª–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞), —Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç "–æ–±–Ω—É–ª–µ–Ω–∏–µ" —Å–ø–∏—Å–∫–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö¬†`nft flush ruleset`.

## –ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ–º–µ–Ω–æ–≤

–ö–∞–∂–¥–æ–º—É –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã—Ç–∞—Å–∫–∏–≤–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –¥–æ–º–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–æ–≤–æ–ª—å–Ω–æ –Ω–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞. –ü–æ—ç—Ç–æ–º—É —è¬†[—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª](https://t.me/itdoginfo/36)¬†—Å–≤–æ–∏ —Å–ø–∏—Å–∫–∏ –¥–æ–º–µ–Ω–æ–≤. –î–∞, –∏–º–µ–Ω–Ω–æ —Å–ø–∏—Å–∫–ò. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Ö –≤—Å–µ—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ –∏ –∂–∏—Ç—å —Ö–æ—Ä–æ—à–æ!

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –µ—Å—Ç—å —Ç—Ä–∏ —Å–ø–∏—Å–∫–∞:

- –†–æ—Å—Å–∏—è, –¥–ª—è –ª—é–¥–µ–π –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã. –¢—É—Ç –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ –¥—É–º–∞—é  
- –†–æ—Å—Å–∏—è, –¥–ª—è –ª—é–¥–µ–π –∏–∑–≤–Ω–µ. –°–ø–∏—Å–æ–∫ –∏–∑ —Å–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—É—Å–∫–∞—é—Ç –∫ —Å–µ–±–µ —Ç–æ–ª—å–∫–æ —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö IP-–∞–¥—Ä–µ—Å–æ–≤  
- –£–∫—Ä–∞–∏–Ω–∞. –¢—É—Ç –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë—Ç—Å—è —Å–ø–∏—Å–æ–∫ —Å —Ä–µ—Å—É—Ä—Å–∞¬†[https://uablacklist.net/](https://uablacklist.net/)

–†–∞–Ω—å—à–µ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—èdnsmasq –ø—Ä—è–º–æ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ. –Ø —Å–¥–µ–ª–∞–ª —É–∂–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–¥–ª—è dnsmasq –∏ –ø–æ–ª—É—á–∏–ª–∏—Å—å —Ç–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã:

- RAW - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–∫–∏ –¥–æ–º–µ–Ω–æ–≤  
- Dnsmasq ipset - –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–¥–ª—è ipset+iptables (–î–ª—è OpenWrt 21–æ–π –≤–µ—Ä—Å–∏–∏ –∏ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö)  
- Dnsmasq nfset - –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–¥–ª—è nfset+nftables (–î–ª—è OpenWrt –Ω–∞—á–∏–Ω–∞—è —Å 22–æ–π –≤–µ—Ä—Å–∏–∏)

–°–µ–π—á–∞—Å –æ–Ω–∏ –ª–µ–∂–∞—Ç –ø—Ä–æ—Å—Ç–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞ GitHub:  
[https://github.com/itdoginfo/allow-domains](https://github.com/itdoginfo/allow-domains)

–ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –æ —Ç–æ–º, –∫–∞–∫ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –¥–æ–º–µ–Ω—ã, –∫–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Å–ø–∏—Å–∫–∏ –∏ —Ç.–¥. –º–æ–∂–Ω–æ –≤ README —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.  
–ù—É –∞ –µ—Å–ª–∏ –≤—ã –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ –≤–∞—à –¥–æ–º–µ–Ω —Ç–æ—á–Ω–æ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –≤–∞–º –∏–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –µ–≥–æ –¥—Ä—É–≥–∏–º üòâ, —Ç–æ –≤ –∫–æ–Ω—Ü–µ —Å—Ç–∞—Ç—å–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –µ–≥–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞.
## –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –¥–æ–º–µ–Ω–æ–≤

–ü–ª—é—Å—ã:

- –í—ã –æ–ø–µ—Ä–∏—Ä—É–µ—Ç–µ –¥–æ–º–µ–Ω–∞–º–∏, –Ω–µ –æ–ø—É—Å–∫–∞–µ—Ç–µ—Å—å –¥–æ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥  
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å: –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–æ—É—Ç–∏–Ω–≥–∞ –≤ –ª—é–±–æ–π —Å—Ç—Ä–∞–Ω–µ  
- –í sets –Ω–µ –±—É–¥–µ—Ç IP-–∞–¥—Ä–µ—Å–∞ –≤–∞—à–µ–≥–æ VPN-—Å–µ—Ä–≤–µ—Ä–∞  
- –ü–æ–º–∏–º–æ –≥–æ—Ç–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–æ–º–µ–Ω–æ–≤, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –ø—Ä—è–º –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ  
- –í –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —É—á–∞—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ IP-–∞–¥—Ä–µ—Å–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ –¥–æ–º–µ–Ω–æ–≤. –ú–µ–Ω—å—à–µ IP-–∞–¥—Ä–µ—Å–æ–≤ –≤ —Å–ø–∏—Å–∫–∞—Ö - –º–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

–ú–∏–Ω—É—Å—ã:

- ~~–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–∞ –Ω–µ –∏–¥–µ–∞–ª–µ–Ω. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–∞–π—Ç—É –≤–∞–º –ø—Ä–∏–¥—ë—Ç—Å—è –Ω–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å, —á—Ç–æ–± dnsmasq –¥–æ–±–∞–≤–∏–ª IP-–∞–¥—Ä–µ—Å –≤ sets. –ù–æ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ~~¬†**UPD 9.03.2024**¬†–ù–∞ 23.05 –≤—Å—ë –ª–µ—Ç–∞–µ—Ç.  
- –°—É—â–µ—Å—Ç–≤—É—é—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç DNS-—Å–µ—Ä–≤–µ—Ä —Ä–æ—É—Ç–µ—Ä–∞, –∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–≤–æ—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ä–µ–∑–æ–ª–≤–∏–Ω–≥–∞ –ø—Ä—è–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ –∫–æ–Ω—Ü–µ —Å—Ç–∞—Ç—å–∏.
## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–¢—É—Ç –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–π –º–∞–≥–∏–∏, –≤—Å—ë —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –¥–æ–≤–æ–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ open source –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏. –î–≤–∞ –≥–ª–∞–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞ —ç—Ç–æ–π –∑–∞—Ç–µ–∏ - —ç—Ç–æ dnsmasq –∏ nftables.

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤—Å—ë –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Å–∞–π—Ç–∞¬†[**graylog.org**](http://graylog.org/). WAF Cloudflare –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É –Ω–µ–≥–æ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ —Å—Ç—Ä–∞–Ω–µ, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å —Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ IP –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω.

–î–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–∞–π—Ç–æ–º –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–æ—É—Ç–µ—Ä—É DNS –∑–∞–ø—Ä–æ—Å, –≤ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ—Å–∏—Ç –∑–∞—Ä–µ–∑–æ–ª–≤–∏—Ç—å –¥–æ–º–µ–Ω. –ù–∞—á–∏–Ω–∞—è —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º —Ä–æ—É—Ç–∏–Ω–≥–∞. –ó–∞ DNS –≤ OpenWrt –æ—Ç–≤–µ—á–∞–µ—Ç dnsmasq. –£ –Ω–µ–≥–æ –µ—Å—Ç—å –∫—Ä—É—Ç–∞—è —Ñ–∏—á–∞: –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –¥–æ–º–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –≤—Å–µ –∑–∞—Ä–µ–∑–æ–ª–≤–µ–Ω–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞ —ç—Ç–æ–≥–æ –¥–æ–º–µ–Ω–∞ –æ–Ω –±—É–¥–µ—Ç —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ nftables sets.

–í—ã–≥–ª—è–¥–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º:

```
config ipset
list name 'vpn_domains'
list domain 'graylog.org'
```

`list name`¬†- —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π set, –≤ –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å IP-–∞–¥—Ä–µ—Å–∞.

Dnsmasq –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥ –¥–æ–º–µ–Ω–∞¬†[graylog.org](http://graylog.org/), —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥—Ä–µ—Å —É –≤—ã—à–µ—Å—Ç–æ—è—â–µ–≥–æ DNS —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–ª—É—á–∞–µ—Ç –∏—Ö. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ç–¥–∞—ë—Ç IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç—É –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –∏—Ö –≤ set vpn_domains.

–î–∞–ª–µ–µ, –∫–æ–≥–¥–∞ —Ä–æ—É—Ç–µ—Ä—É –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–∞–∫–µ—Ç, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫ IP-–∞–¥—Ä–µ—Å—É –∏–∑ —Å–ø–∏—Å–∫–∞, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–Ω—è—Ç—ã–π —Ç—É–Ω–Ω–µ–ª—å. –ê –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Ñ–∏–∫ –∏–¥—ë—Ç, –∫–∞–∫ —Ä–∞–Ω—å—à–µ - —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ –æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Ç—É–Ω–Ω–µ–ª—è—Ö –±—É–¥–µ—Ç —á—É—Ç—å –¥–∞–ª—å—à–µ, –∞ –ø–æ–∫–∞ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ö–µ–º—É —Ä–∞–±–æ—Ç—ã, –∫–æ—Ç–æ—Ä—É—é —è –Ω–∞—Ä–∏—Å–æ–≤–∞–ª –≤ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ –±–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –º–µ—Ç–æ–¥—É:

![|400](/Media/OpenWRT_point_routing/mm_5wap6pofl_w17zdvifkddrl8.gif)

## –ß—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è

![|400](/Media/OpenWRT_point_routing/1uzyofb0c6mqxeapxwtkggr8bf0.png)

1. –í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, —Ä–æ—É—Ç–µ—Ä, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π OpenWrt. –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç —Ä–æ—É—Ç–µ—Ä–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–≥–æ OpenWrt, —Ç–æ —è —Å–æ—Å—Ç–∞–≤–∏–ª¬†[—Å–ø–∏—Å–æ–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤](https://habr.com/ru/articles/725386/), –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –≤ –†–æ—Å—Å–∏–∏ –∏ –≤ —Å–æ—Å–µ–¥–Ω–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö. –° –≤—ã—Ö–æ–¥–æ–º 23.05 —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤ —Ä–∞—Å—à–∏—Ä–∏–ª—Å—è, —Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–∏—Å–∫—É –≤ –∫–æ–Ω—Ü–µ —Ç–æ–π —Å—Ç–∞—Ç—å–∏.

2. –ö–∞–∫–æ–π-–Ω–∏–±—É–¥—å VPN. –¢–æ—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å OpenWrt: Wireguard, OpenVPN, Shadowsocks.  
–ï—Å–ª–∏ –¥–∞–≤–Ω–æ —Ö–æ—Ç–µ–ª–∏ —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä —Å VPN, —Ç–æ –≤–æ—Ç –º–æ—è¬†[–ø–æ–¥–±–æ—Ä–∫–∞ VPS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤](https://habr.com/ru/articles/729750/), —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —ç–∫–≤–∞–π—Ä–∏–Ω–≥ –∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤–Ω–µ –†–æ—Å—Å–∏–∏ (–≤ –†–æ—Å—Å–∏–∏ —É –Ω–∏—Ö —Ç–æ–∂–µ –µ—Å—Ç—å). Wireguard –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ. –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –Ω–µ–≥–æ, —á—Ç–æ–± –Ω–µ –∑–∞–±—É–∫—Å–æ–≤–∞—Ç—å –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ.¬†[–°—Ç–∞—Ç—å—è —Å –æ–±–∑–æ—Ä–æ–º —Ä–µ—à–µ–Ω–∏–π](https://habr.com/ru/articles/738890/)¬†–¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WG-—Å–µ—Ä–≤–µ—Ä–æ–º.

3. –£–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏ Linux –∏–ª–∏ –∂–µ–ª–∞–Ω–∏–µ –Ω–∞—É—á–∏—Ç—å—Å—è —ç—Ç–æ–º—É.

4. –û—Å–æ–∑–Ω–∞–Ω–∏–µ, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ VPN –Ω–∞ –≤–∏–Ω–¥—É, –∞ —Ä–µ—à–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è—â–µ–µ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–≤—è–∑–∞–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –ø—Ä–∏–¥—ë—Ç—Å—è —Å—Ç—Ä–∞–¥–∞—Ç—å –∏ —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è.
## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ shell-—Å–∫—Ä–∏–ø—Ç

–Ø –Ω–∞–ø–∏—Å–∞–ª —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –≤—Å—ë, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∏–∂–µ.  
–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —É –≤–∞—Å —Å–≤–µ–∂–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ OpenWrt –∏–ª–∏ –Ω–µ –æ—Å–æ–±–æ –Ω–∞–≤–æ—Ä–æ—á–µ–Ω–Ω–∞—è. –í —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —Ç—É–Ω–Ω–µ–ª–∏, –∏ –∫–∞–∫–∞—è-—Ç–æ –¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞, —Å–∫—Ä–∏–ø—Ç –º–æ–∂–µ—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω–æ.

>–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –Ω–∞ —Ä–æ—É—Ç–µ—Ä –ø–æ ssh –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å:
```shell
sh <(wget -O - https://raw.githubusercontent.com/itdoginfo/domain-routing-openwrt/master/getdomains-install.sh)
```

Habr –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ asciinema. –í–∏–∑—É–∞–ª—å–Ω–æ —Ö–æ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–∞–π—Ç–µ asciinema:  
[https://asciinema.org/a/614149](https://asciinema.org/a/614149)

–í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –≤–∞–º –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∫–∞–∫–æ–π —Ç—É–Ω–Ω–µ–ª—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä. –î–ª—è WG –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∏ —Å–∫—Ä–∏–ø—Ç –≤–∞–º —Å–∞–º –Ω–∞—Å—Ç—Ä–æ–∏—Ç WG.

OpenVPN, sing-box, tun2socks –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç—Å—è —á—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ. –ü–æ—ç—Ç–æ–º—É –¥–ª—è –Ω–∏—Ö —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–æ–Ω–∞, –ø—Ä–∞–≤–∏–ª–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏. –ê —Å–∞–º—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–∞ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∏–∂–µ. –î–ª—è sing-box —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª —Å —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–µ–º–ø–ª–µ–π—Ç–æ–º.

–ï—Å–ª–∏ –≤–∞—à –ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ–¥–º–µ–Ω—è–µ—Ç DNS –∑–∞–ø—Ä–æ—Å—ã, —Ç–æ —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É DNSCrypt-proxy2 –∏–ª–∏ stubby. –í—Ç–æ—Ä–æ–π –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–∞–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –º–µ—Å—Ç–∞, –¥–∞–≤–∞—è —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ, –Ω—É–∂–Ω–æ –ª–∏ –æ–Ω–æ –≤–∞–º, –º–æ–∂–µ—Ç–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å. –ü–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ –∑–∞–ø—É—Å—Ç—è —Å–∫—Ä–∏–ø—Ç.

–î–∞–ª–µ–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤.

–° –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞ –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –æ–¥–∏–Ω —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –¥—Ä—É–≥–æ–π. –û–Ω –∏—Å–ø—Ä–∞–≤–∏—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤ firewall. –ù–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–æ–π —Ç—É–Ω–Ω–µ–ª—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, —É –≤–∞—Å –±—ã–ª OpenVPN —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º tun0, –∏ –≤—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ sing-box. –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤. –ù—É–∂–Ω–æ –±—É–¥–µ—Ç —Å—Ç–æ–ø–Ω—É—Ç—å openvpn —Å–ª—É–∂–±—É –∏ —É–±—Ä–∞—Ç—å –µ—ë –∏–∑ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞. –ò–ª–∏ –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –ø–æ–º–µ–Ω—è—Ç—å –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö —Å tun0 –Ω–∞ tun1.

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é, —á–∏—Ç–∞–π—Ç–µ –¥–∞–ª—å—à–µ.
### –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å

OpenWrt –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—É–Ω–Ω–µ–ª–µ–π. –ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —ç—Ç—É —Å—Ç–∞—Ç—å—é, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –µ—Å—Ç—å —Å–≤–æ–π –º–∞–Ω—É–∞–ª:

- [Wireguard –Ω–∞ OpenWrt](https://itdog.info/nastrojka-klienta-wireguard-na-openwrt/)  
- [OpenVPN –Ω–∞ OpenWrt](https://itdog.info/nastrojka-klienta-openvpn-na-openwrt/)  
- [OpenConnect –Ω–∞ OpenWrt](https://itdog.info/nastrojka-klienta-openconnect-na-openwrt/)  
- [Sing-box –∏ tun2socks –Ω–∞ OpenWrt](https://habr.com/ru/articles/767458/). –û–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç Shadowsocks, SOCKS5, Trojan, VMess, VLESS –∏—Ç–¥

–ï—Å–ª–∏ –≤—ã –ø–æ–∫—É–ø–∞–µ—Ç–µ VPN –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç, –æ–Ω, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OpenVPN.
### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤

–í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –Ω—É–∂–µ–Ω –ø–∞–∫–µ—Ç dnsmasq-full. –ü–æ –¥–µ—Ñ–æ–ª—Ç—É –≤ OpenWrt –∏–¥—ë—Ç —É—Ä–µ–∑–∞–Ω–Ω—ã–π dnsmasq –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞.

![|400](/Media/OpenWRT_point_routing/ppelmojibbdeeofz2rd72dpgha4.png)

Dnsmasq –∫–ª—é—á–µ–≤–æ–π –ø–∞–∫–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ –∏ –µ–≥–æ —É–¥–∞–ª–µ–Ω–∏–µ –ª–æ–º–∞–µ—Ç DNS –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ. –ü–æ—ç—Ç–æ–º—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –≤—ã–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ –ø–∞–∫–µ—Ç –≤ /tmp.  

>–ï—Å–ª–∏ —É –≤–∞—Å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤¬†`/etc/config/dhcp`, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É, –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é.
```shell
opkg update && cd /tmp/ && opkg download dnsmasq-full
opkg remove dnsmasq && opkg install dnsmasq-full --cache /tmp/
mv /etc/config/dhcp-opkg /etc/config/dhcp
```

>–¢–∞–∫–∂–µ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –∏ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è curl
```shell
opkg install curl
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

–ß—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫–æ–º, –µ–≥–æ –Ω—É–∂–Ω–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Ñ–∞–µ—Ä–≤–æ–ª–∞ –∏ –≤–µ—Å—å –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏. –ê –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É, –±—É–¥–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ —Ç—É–Ω–Ω–µ–ª—å.

>–ù–∞—á–Ω—ë–º —Å —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏. –ú–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π
```
echo '99 vpn' >> /etc/iproute2/rt_tables
```

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é —Å—Ç—Ä–æ–∫—É¬†`99 vpn`¬†–ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–æ–π –≤ —Ñ–∞–π–ª /etc/iproute2/rt_tables.

>–î–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª–æ, —á—Ç–æ–± –≤–µ—Å—å –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ —É—Ö–æ–¥–∏–ª –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É. –ß–µ—Ä–µ–∑ UCI:
```
uci add network rule
uci set network.@rule[-1].name='mark0x1'
uci set network.@rule[-1].mark='0x1'
uci set network.@rule[-1].priority='100'
uci set network.@rule[-1].lookup='vpn'
uci commit network
```

>–õ–∏–±–æ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –≤ —Ñ–∞–π–ª¬†`/etc/config/network`
```
config rule
	option name 'mark0x1'
	option mark '0x1'
	option priority '100'
	option lookup 'vpn'
```

![|400](/Media/OpenWRT_point_routing/_sp5lpujhgk2t0yhllrsknfqp7k.gif)

–î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–± –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É, —É—Ö–æ–¥–∏–ª –≤ —Ç—É–Ω–Ω–µ–ª—å.

>–í —Å–ª—É—á–∞–µ c WG –∏—Å–ø–æ–ª—å–∑—É–µ–º interface wg0. –†–∞–Ω—å—à–µ —á–µ—Ä–µ–∑ UCI –Ω–µ–ª—å–∑—è –±—ã–ª–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∏ –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –∫–æ—Å—Ç—ã–ª—è—Ç—å —á–µ—Ä–µ–∑ hotplug. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ UCI:
```shell
uci set network.vpn_route=route
uci set network.vpn_route.interface='wg0'
uci set network.vpn_route.table='vpn'
uci set network.vpn_route.target='0.0.0.0/0'
uci commit network
```

>–õ–∏–±–æ –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ –≤¬†`/etc/config/network`
```q
config route 'vpn_route'
	option name 'vpn'
	option interface 'wg0'
	option table 'vpn'
	option target '0.0.0.0/0'
```

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å —Ç–æ—á–µ—á–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É¬†`option interface`.

–í —Å–ª—É—á–∞–µ —Å OpenVPN, Sing-box, tun2socks –≤—Å—ë —Ç–∞–∫ –∂–µ –∫–æ—Å—Ç—ã–ª—è–µ–º —á–µ—Ä–µ–∑ hotplug. –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ —Å–∞–º–∏ —Å–æ–∑–¥–∞—é—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç—Å—è –≤ OpenWrt –∫–∞–∫¬†`device`, –∞ —Ç–∏–ø¬†`device`¬†–≤ route –∑–∞–ø–∏—Å–∞—Ç—å –Ω–µ–ª—å–∑—è.

>–°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª¬†`/etc/hotplug.d/iface/30-vpnroute`¬†—Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º –≤–Ω—É—Ç—Ä–∏:
```shell
#!/bin/sh

sleep 10
ip route add table vpn default dev tun0
```

–ó–∞–¥–µ—Ä–∂–∫–∞ –Ω—É–∂–Ω–∞ –¥–ª—è sing-box. –í–µ—Ä–æ—è—Ç–Ω–æ, –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –Ω–µ—ë.

–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –ø—Ä–æ—Å–ª–æ–π–∫–æ–π –≤¬†`/etc/config/network`, —á—Ç–æ –±—ã –≤ route –∑–∞–∫–∏–¥—ã–≤–∞—Ç—å interface. –ù–æ –Ω–∞ sing-box –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å tun0 –Ω–µ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–µ—Ç–∏. –í–µ—Ä–æ—è—Ç–Ω–æ, –¥–ª—è OpenVPN –º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ. 

>–ü–æ—ç—Ç–æ–º—É –≤–æ—Ç –ø—Ä–∏–º–µ—Ä —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø—Ä–æ—Å–ª–æ–π–∫–∏:
```q
config interface 'vpn0'
	option name 'vpn0'
	option proto 'none'
	option auto '1'
	option device 'tun0'

config route 'vpn_route'
	option name 'vpn_route'
	option interface 'vpn0'
	option table 'vpn'
	option target '0.0.0.0/0'
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ö–æ–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å. –≠—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–∏—Å–∞–Ω–∞ –≤ –∫–∞–∂–¥–æ–º –º–∞–Ω—É–∞–ª–µ –ø–æ —Ç—É–Ω–Ω–µ–ª—è–º.  

>–î–æ–±–∞–≤–ª—è–µ–º nftables set —Å –∏–º–µ–Ω–µ–º vpn_domains, —ç—Ç–æ —Å–ø–∏—Å–æ–∫, –∫—É–¥–∞ –±—É–¥—É—Ç —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è IP-–∞–¥—Ä–µ—Å–∞. –ò –ø—Ä–∞–≤–∏–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –º–∞—Ä–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∏–¥—ë—Ç –∫ IP-–∞–¥—Ä–µ—Å–∞–º –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.
```shell
uci add firewall ipset
uci set firewall.@ipset[-1].name='vpn_domains'
uci set firewall.@ipset[-1].match='dst_net'

uci add firewall rule
uci set firewall.@rule[-1]=rule
uci set firewall.@rule[-1].name='mark_domains'
uci set firewall.@rule[-1].src='lan'
uci set firewall.@rule[-1].dest='*'
uci set firewall.@rule[-1].proto='all'
uci set firewall.@rule[-1].ipset='vpn_domains'
uci set firewall.@rule[-1].set_mark='0x1'
uci set firewall.@rule[-1].target='MARK'
uci set firewall.@rule[-1].family='ipv4'
uci commit firewall
```

–§–∞–π–ª—ã, –æ—Ç–∫—É–¥–∞ –±—É–¥–µ–º –±—Ä–∞—Ç—å IP-–∞–¥—Ä–µ—Å–∞, –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã. –í–∞—à —Ä–æ—É—Ç–µ—Ä —Å–∞–º –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ IP-–∞–¥—Ä–µ—Å–æ–≤ –ø–æ–¥ –≤–∞—à–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏.
### –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ —Å–∫—Ä–∏–ø—Ç–æ–º

–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π¬†[—Å–∫—Ä–∏–ø—Ç hivpn](https://itdog.info/tochechnaya-marshrutizaciya-na-routere-s-openwrt-wireguard-i-dnscrypt/#%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b0-%d1%81%d0%bf%d0%b8%d1%81%d0%ba%d0%be%d0%b2)¬†—Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —Ä–∞–∑—Ä–æ—Å—Å—è –Ω–æ–≤—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏, –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –¥–ª—è –¥–æ–º–µ–Ω–æ–≤. –ê –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ IP-–∞–¥—Ä–µ—Å–æ–≤ –≤ sets –∑–∞–Ω–∏–º–∞–ª–∞ –ø—Ä–∏–ª–∏—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏.  
–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –¥–æ–º–µ–Ω–æ–≤ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫, –∞ —Ç–æ—á–Ω–µ–µ, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è dnsmasq, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–∫–∏–Ω—É—Ç—å –≤¬†`/tmp/dnsmasq.d/`. –¢–∞–º —Ö—Ä–∞–Ω—è—Ç—Å—è "–≤—Ä–µ–º–µ–Ω–Ω—ã–µ" –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ dnsmasq.

>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
```q
nftset=/graylog.org/4#inet#fw4#vpn_domains
nftset=/terraform.io/4#inet#fw4#vpn_domains
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–∑–æ–ª–≤–∏–Ω–≥ –¥–æ–º–µ–Ω–∞¬†[graylog.org](http://graylog.org/)¬†–∏ –≤—Å–µ—Ö –µ–≥–æ —Å—É–±–¥–æ–º–µ–Ω–æ–≤, –≤—Å–µ –∑–∞—Ä–µ–∑–æ–ª–≤–µ–Ω–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ —Å–ø–∏—Å–æ–∫ vpn_domains.  
–ö–æ–≥–¥–∞ —è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª¬†[community —Å–ø–∏—Å–æ–∫](https://community.antifilter.download/)¬†–æ—Ç antifilter.download, –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –≤ dnsmasq –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Å–∫—Ä–∏–ø—Ç–æ–º –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ. –ù–æ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥–æ —Å–∫–∞—á–∞—Ç—å.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —Ç–µ–ø–µ—Ä—å –≤—Å—ë, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç–æ–º:

- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –¢—É—Ç –ø–æ—è—Å–Ω—é: –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ—É—Ç–µ—Ä–∞ –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–µ —Å—Ä–∞–∑—É (–ø–æ–∏—Å–∫ —Å–µ—Ç–∏ –≤ 4G, –æ—Ç—Å—É—Å—Ç–≤–∏–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ —É –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–∞ –≤ –¥–æ–º–µ) –∏ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ—Å—Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç —Ä–æ—É—Ç–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç. –ë–µ–∑ —Ç–∞–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ —Ä–æ—É—Ç–µ—Ä –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –≤—Ä—É—á–Ω—É—é  
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –≤¬†`/tmp/dnsmasq.d/`  
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞. –£ –º–µ–Ω—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω CI, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–∏–≥–æ–≤ –ø–æ—Å–ª–µ –∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –Ω–æ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—à–Ω–µ–π –Ω–µ –±—É–¥–µ—Ç  
- –ï—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞—è, —Ç–æ —Ä–µ—Å—Ç–∞—Ä—Ç Dnsmasq

–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –¥–ª—è inside-dnsmasq-nfset.lst. –°—Å—ã–ª–∫–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ¬†[—Å–ø–∏—Å–∫–∏](https://github.com/itdoginfo/allow-domains#%D1%80%D0%BE%D1%81%D1%81%D0%B8%D1%8F)¬†–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

```shell
#!/bin/sh /etc/rc.common

START=99

start () {
DOMAINS=https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/inside-dnsmasq-nfset.lst

count=0
while true; do
if curl -m 3 github.com; then
curl -f $DOMAINS --output /tmp/dnsmasq.d/domains.lst
break
else
echo "GitHub is not available. Check the internet availability [$count]"
count=$((count+1))
fi
done

if dnsmasq --conf-file=/tmp/dnsmasq.d/domains.lst --test 2>&1 | grep -q "syntax check OK"; then
/etc/init.d/dnsmasq restart
fi
}
```

–°–∫–ª–∞–¥—ã–≤–∞–µ–º –µ–≥–æ –≤¬†`/etc/init.d/getdomains`.

>–î–µ–ª–∞–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É
```shell
chmod +x /etc/init.d/getdomains
ln -sf ../init.d/getdomains /etc/rc.d/S99getdomains
```

>–î–æ–±–∞–≤–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤. –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```shell
crontab¬†`crontab -e`  
```

>–ò –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
```
0 */8 * * * /etc/init.d/getdomains start
```

>–†–µ—Å—Ç–∞—Ä—Ç—É–µ–º —Å–µ—Ç—å –∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≤—Ä—É—á–Ω—É—é
```shell
service network restart
service getdomains start
```

![|600](/Media/OpenWRT_point_routing/9on7x6mcdb23dlu19xspxqqtczw.gif)

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ—á–µ—á–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ üéâ
### –°–≤–æ–∏ –¥–æ–º–µ–Ω—ã

–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è`/etc/config/dhcp`¬†–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü:

```q
config ipset
list name 'vpn_domains'
list domain 'graylog.org'
list domain 'terraform.io'
```

–ö–∞–∂–¥—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–æ–º–µ–Ω –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–æ–π. Dnsmasq —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ wildcard, –ø–æ—ç—Ç–æ–º—É —Å—É–±–¥–æ–º–µ–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.

>–î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω—É–∂–Ω–æ —Ä–µ—Å—Ç–∞—Ä—Ç–∞–Ω—É—Ç—å dnsmasq
```shell
service dnsmasq restart
```
### –ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–∞—Ä—É—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É DNS

–£ –≤–∞—Å –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ—á–µ—á–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥, –Ω–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –±—É–¥–µ—Ç –ø–æ–¥–º–µ–Ω—è—Ç—å IP-–∞–¥—Ä–µ—Å–∞ —É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤. –ò–∑-–∑–∞ —ç—Ç–æ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

–ö–∞–∫–∏–µ –±—ã–≤–∞—é—Ç —Å–∏—Ç—É–∞—Ü–∏–∏?  
–û–ø–∏—à—É, —á—Ç–æ —è –≤–∏–¥–µ–ª –ª–∏—á–Ω–æ. –ü–æ–π–¥—ë–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –≤ —Å—Ç–µ–ø–µ–Ω–∏ —É–ø–æ—Ä–æ—Ç–æ—Å—Ç–∏.

1. DNS-—Å–µ—Ä–≤–µ—Ä—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–º–µ–Ω—è—é—Ç IP-–∞–¥—Ä–µ—Å–∞, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è—Ç—å DNS —Å–µ—Ä–≤–µ—Ä –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä—Å–∫–æ–≥–æ –Ω–∞ 8.8.8.8, 8.8.4.4 –∏ —Ç.–¥  
2. DNS-—Å–µ—Ä–≤–µ—Ä—ã –ø–æ–¥–º–µ–Ω—è—é—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–≤–æ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö. –ü–æ–º–∏–º–æ —ç—Ç–æ–≥–æ, –µ—Å–ª–∏ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –¥—Ä—É–≥–∏–º DNS-—Å–µ—Ä–≤–µ—Ä–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä 8.8.8.8), —Ç–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –∏ –ø–æ–¥–º–µ–Ω—è–µ—Ç –∏—Ö.  
3. –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Ç—É–ø–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –ø–æ 53 –ø–æ—Ä—Ç—É, –∫—Ä–æ–º–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–≤–æ–∏–º DNS-—Å–µ—Ä–≤–µ—Ä–∞–º. –¢—É—Ç –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ DNS-—Å–µ—Ä–≤–µ—Ä—ã.

–ï—Å–ª–∏ —É –≤–∞—Å –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, —Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π—Ç–µ DNS-—Å–µ—Ä–≤–µ—Ä –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. –ê –≤–æ—Ç –µ—Å–ª–∏ 2 –∏–ª–∏ 3, —Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–æ–ª–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DNS over TLS –∏–ª–∏ DNS over HTTPS.

–î–ª—è OpenWrt –µ—Å—Ç—å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

- DNSCrypt-proxy2 - –º–Ω–æ–≥–æ —á–µ–≥–æ —É–º–µ–µ—Ç, –Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç 10.7M  
- Stubby - –Ω–µ —Ç–∞–∫–æ–π –Ω–∞–≤–æ—Ä–æ—á–µ–Ω–Ω—ã–π –∏ –ø–æ—ç—Ç–æ–º—É –∑–∞–Ω–∏–º–∞–µ—Ç 36K + –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

–û–±–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ä–µ—à–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã 2 –∏ 3. –í—ã–±–∏—Ä–∞—Ç—å –≤–∞–º. –ï—Å–ª–∏ —É –≤–∞—Å –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ 16–ú —Ñ–ª–µ—à–∫–∞, —Ç–æ –≤—ã–±–æ—Ä –æ—á–µ–≤–∏–¥–µ–Ω.
#### DNSCrypt-proxy2

```shell
opkg update && opkg install dnscrypt-proxy2
```

–ï–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤¬†`/etc/dnscrypt-proxy2/dnscrypt-proxy.toml`  
–ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –≤¬†`server_names`.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω—É–∂–µ–Ω —Ä–µ—Å—Ç–∞—Ä—Ç

```shell
service dnscrypt-proxy restart
```

–ü–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑–æ–ª–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —à–∏—Ñ—Ä—É–µ—Ç —Å–≤–æ–∏ –∑–∞–ø—Ä–æ—Å—ã. –û–Ω –≤–∏—Å–∏—Ç –ø–æ –¥–µ—Ñ–æ–ª—Ç—É –Ω–∞¬†`127.0.0.53:53`.

–ú–æ–∂–Ω–æ –ø–æ—Å–ª–∞—Ç—å –µ–º—É DNS-–∑–∞–ø—Ä–æ—Å –ø—Ä—è–º–æ –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ

```shell
nslookup itdog.info 127.0.0.53:53
```

–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º dnsmasq, —á—Ç–æ–± –æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª dnscrypt –∫–∞–∫ DNS-—Å–µ—Ä–≤–µ—Ä.

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ¬†`/etc/config/dhcp`¬†–≤ –±–ª–æ–∫–µ¬†`config dnsmasq`

- –£–±—Ä–∞—Ç—å –∏–ª–∏ –∑–∞–∫–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã¬†`list server`  
- –î–æ–±–∞–≤–∏—Ç—å¬†`option noresolv '1'`  
- –î–æ–±–∞–≤–∏—Ç—å dnscrypt –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä¬†`list server '127.0.0.53#53'`

–ú–æ–∂–Ω–æ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã UCI:

```shell
uci set dhcp.@dnsmasq[0].noresolv="1"
uci -q delete dhcp.@dnsmasq[0].server
uci add_list dhcp.@dnsmasq[0].server="127.0.0.53#53"
uci commit dhcp
```

>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å dnsmasq
```shell
service dnsmasq restart
```
#### Stubby

```shell
opkg update && opkg install stubby
```

Stubby –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ –¥–µ—Ñ–æ–ª—Ç—É DNS-—Å–µ—Ä–≤–µ—Ä—ã Cloudflare. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤¬†`/etc/config/stubby`.  
–ü–æ –¥–µ—Ñ–æ–ª—Ç—É –≤–∏—Å–∏—Ç –Ω–∞¬†`127.0.0.1:5453`.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ dnsmasq –∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è, —Ç–æ–ª—å–∫–æ –≤–º–µ—Å—Ç–æ¬†`127.0.0.53#53`, –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å¬†`127.0.0.1#5453`.
### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ Ansible

–ü–ª–µ–π–±—É–∫ –ø—Ä–æ–∞–ø–≥—Ä–µ–¥–∂–µ–Ω:

- –¢–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ –Ω–µ–≥–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å OpenVPN –∏ sing-box, –ø–æ–∫–∞ —á—Ç–æ —Ç–æ–∂–µ –≤ –ø–æ–ª—É—Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ  
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–º–∏–º–æ –¥–æ–º–µ–Ω–æ–≤ –µ—â—ë —Å–ø–∏—Å–∫–∏ IP-–∞–¥—Ä–µ—Å–æ–≤  
- –ü–æ—è–≤–∏–ª—Å—è –≤—ã–±–æ—Ä –º–µ–∂–¥—É DNSCrypt-proxy2 –∏ Stubby, –ª–∏–±–æ –≤–æ–æ–±—â–µ –∏—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ  
- –î–ª—è –¥–æ–º–µ–Ω–æ–≤ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —Å–ø–∏—Å–æ–∫  
- –ò —á–µ—Ä–µ–∑ –Ω–µ–≥–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤—Å–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ (21, 22, 23) –≤–µ—Ä—Å–∏–∏ OpenWrt  

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤¬†[—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏](https://github.com/itdoginfo/domain-routing-openwrt).
## –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–ï—Å—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –æ—à–∏–±–æ–∫. –ö–∞–∫ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–æ¬†[—Ç—É—Ç](https://github.com/itdoginfo/domain-routing-openwrt?tab=readme-ov-file#%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82-%D0%B4%D0%BB%D1%8F-%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8)

![|600](/Media/OpenWRT_point_routing/bddnqecdesdzzk-hpbdm09l1q68.png)

–¢–∞–∫–∂–µ –µ—Å—Ç—å¬†[–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç—å—è](https://habr.com/ru/articles/702388/), —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º —Ä–∞–∑–±–æ—Ä–æ–º –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞.  
–í –ø–ª–∞–Ω–µ —Ç—É–Ω–Ω–µ–ª–µ–π —Ç–∞–º –æ–ø–∏—Å–∞–Ω –ø–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è WG. OpenVPN –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫ –∂–µ, –∞ –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä—è—Ç—å sing-box –∏ tun2socks –æ–ø–∏—Å–∞–Ω–æ –≤ –∏—Ö¬†[—Å—Ç–∞—Ç—å–µ](https://habr.com/ru/articles/767458/).  
–ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, –µ—Å—Ç—å¬†[—á–∞—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏](https://t.me/itdogchat).
### –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

–¢–∞–∫–æ–µ –º–æ–∂–µ—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ DNS –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ —Ä–æ—É—Ç–µ—Ä–∞. –ò –ø—Ä–∏—á–∏–Ω–∞ –≤ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –¥–∞–∂–µ —Ü–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å—Ç–∞–ª–∏ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É —à–∏—Ñ—Ä–æ–≤–∞—Ç—å DNS.  
–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Ç–∞–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–µ, —Å–ª–æ–≤–∞ –¥–ª—è –≥—É–≥–ª–∞: "$PROGRAM + DNS encrypt/DNS over https/DNS over tls".
#### Firefox

Firefox –∫–∞–∫–æ–µ-—Ç–æ –≤—Ä–µ–º—è –Ω–∞–∑–∞–¥ –Ω–∞—á–∞–ª —ç—Ç–æ –¥–µ–ª–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –¶–∏—Ç–∞—Ç–∞ c¬†[support.mozilla.org](https://support.mozilla.org/ru/kb/dns-cherez-https-v-firefox):

> –í 2019 –≥–æ–¥—É –º—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ DoH –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Firefox –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ –°–æ–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö –®—Ç–∞—Ç–∞—Ö –∏ –≤ 2021 –≥–æ–¥—É ‚Äî –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Firefox –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ –ö–∞–Ω–∞–¥–µ. –ú—ã –Ω–∞—á–∞–ª–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Firefox –Ω–∞ –ü–ö –≤ –†–æ—Å—Å–∏–∏ –∏ –£–∫—Ä–∞–∏–Ω–µ –≤ –º–∞—Ä—Ç–µ 2022 –≥–æ–¥–∞. –°–µ–π—á–∞—Å –º—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ–º DoH –≤ –±–æ–ª—å—à–µ–º —á–∏—Å–ª–µ —Å—Ç—Ä–∞–Ω.

–û—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤¬†**Settings**¬†-¬†**Privacy & Security**¬†- –≤ —Å–∞–º–æ–º –Ω–∏–∑—É¬†**DNS over HTTPS**¬†-¬†**Off**.
#### Android

[–ù–∞—á–∏–Ω–∞—è —Å 9–æ–π –≤–µ—Ä—Å–∏–∏](https://developers.google.com/speed/public-dns/docs/using#android)¬†—ç—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ó–¥–µ—Å—å –∏–¥—ë—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.

–í –æ–±—ã—á–Ω–æ–º Android –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤¬†**Settings**¬†-¬†**Network & Internet**¬†-¬†**Advanced**¬†-¬†**Private DNS**¬†-¬†**Off**

–í MIUI:¬†**Settings**¬†- –≤ –ø–æ–∏—Å–∫–µ "dns" -¬†**Private DNS**¬†-¬†**Off**.

–ü–∏—à–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –≥–¥–µ –µ—â—ë —Å—Ç–∞–ª–∫–∏–≤–∞–ª–∏—Å—å —Å —ç—Ç–∏–º.
### DNS-—Å–µ—Ä–≤–µ—Ä —Ä–æ—É—Ç–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏

–ù–∞–ø—Ä–∏–º–µ—Ä, —É –≤–∞—Å –Ω–∞ –¥–æ–º–∞—à–Ω–µ–º —Å–µ—Ä–≤–µ—Ä–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç DNS-—Å–µ—Ä–≤–µ—Ä –∏ –æ–Ω —Ä–∞–∑–¥–∞—ë—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ DHCP. –í—Å–µ DNS –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –∫ –Ω–µ–º—É, –∞ –Ω–µ –∫ dnsmasq –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ. –í —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ IP-–∞–¥—Ä–µ—Å–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

>–ö–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DNS-—Å–µ—Ä–≤–µ—Ä OpenWrt —Ä–æ—É—Ç–µ—Ä–∞, –∞ –æ–Ω —É–∂–µ –±—É–¥–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –≤–∞—à–µ–º—É –æ—Ç–¥–µ–ª—å–Ω–æ–º—É DNS-—Å–µ—Ä–≤–µ—Ä—É. –≠—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤¬†`/etc/config/dhcp`
```shell
list server '192.168.1.2#53'
```
### IPv6

–í—Å—ë –æ–ø–∏—Å–∞–Ω–Ω–æ–µ —Ç—É—Ç, –∏ —Å–∫—Ä–∏–ø—Ç –≤ —Ç–æ–º —á–∏—Å–ª–µ, –Ω–∞–ø–∏—Å–∞–Ω–æ –¥–ª—è IPv4. –ü–æ–¥–¥–µ—Ä–∂–∫—É IPv6 –Ω—É–∂–Ω–æ –¥–æ–ø–∏–ª–∏–≤–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.  
–Ø —ç—Ç–æ —Å–¥–µ–ª–∞—é, –∫–æ–≥–¥–∞ —É –º–µ–Ω—è –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π IPv6.